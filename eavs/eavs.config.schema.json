{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://raw.githubusercontent.com/byteowlz/schemas/refs/heads/main/eavs/eavs.config.schema.json",
  "title": "EAVS Configuration",
  "description": "Configuration schema for EAVS (Enhanced AI Validation System)",
  "type": "object",
  "properties": {
    "server": {
      "type": "object",
      "description": "Server configuration",
      "properties": {
        "host": {
          "type": "string",
          "description": "Host address to bind to",
          "default": "127.0.0.1",
          "examples": ["127.0.0.1", "0.0.0.0", "localhost"]
        },
        "port": {
          "type": "integer",
          "description": "Port number to listen on",
          "default": 3000,
          "minimum": 1,
          "maximum": 65535
        }
      },
      "additionalProperties": false
    },
    "providers": {
      "type": "object",
      "description": "LLM provider configurations. Keys are provider names (e.g., 'default', 'anthropic')",
      "additionalProperties": {
        "$ref": "#/$defs/provider"
      }
    },
    "upstream": {
      "type": "object",
      "description": "Legacy alias for 'providers'. Use 'providers' instead.",
      "deprecated": true,
      "additionalProperties": {
        "$ref": "#/$defs/provider"
      }
    },
    "logging": {
      "type": "object",
      "description": "Logging configuration",
      "properties": {
        "default": {
          "type": "string",
          "description": "Default logging backend",
          "enum": ["stdout", "file", "none"],
          "default": "stdout"
        },
        "sink": {
          "type": "string",
          "description": "Legacy alias for 'default'. Use 'default' instead.",
          "deprecated": true
        },
        "backends": {
          "type": "array",
          "description": "Additional logging backends",
          "items": {
            "$ref": "#/$defs/logBackend"
          }
        }
      },
      "additionalProperties": false
    },
    "analysis": {
      "type": "object",
      "description": "Analysis pipeline configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable the analysis broadcast channel",
          "default": true
        },
        "broadcast_channel_size": {
          "type": "integer",
          "description": "Size of the broadcast channel buffer",
          "default": 1024,
          "minimum": 1
        },
        "plugins": {
          "type": "array",
          "description": "Optional analysis plugins (external processes) that receive analysis events on stdin and can emit control commands on stdout",
          "default": [],
          "items": {
            "$ref": "#/$defs/analysisPlugin"
          }
        }
      },
      "additionalProperties": false
    },
    "policy": {
      "type": "object",
      "description": "Policy engine configuration (deny/rewrite/filter rules)",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable policy evaluation in the proxy",
          "default": false
        },
        "rules": {
          "type": "array",
          "description": "Ordered list of policy rules applied to requests",
          "default": [],
          "items": {
            "$ref": "#/$defs/policyRule"
          }
        }
      },
      "additionalProperties": false
    },
    "state": {
      "type": "object",
      "description": "Conversation state storage configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable conversation state storage",
          "default": true
        },
        "ttl_secs": {
          "type": "integer",
          "description": "TTL for conversation state in seconds (0 = no expiration)",
          "default": 3600,
          "minimum": 0
        },
        "cleanup_interval_secs": {
          "type": "integer",
          "description": "How often to run cleanup in seconds",
          "default": 60,
          "minimum": 1
        },
        "max_conversations": {
          "type": "integer",
          "description": "Maximum number of conversations to store (0 = unlimited)",
          "default": 10000,
          "minimum": 0
        }
      },
      "additionalProperties": false
    },
    "keys": {
      "type": "object",
      "description": "Virtual API keys configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable virtual API key support",
          "default": false
        },
        "database_path": {
          "type": "string",
          "description": "Path to the SQLite database file. Supports ~ expansion.",
          "default": "~/.eavs/keys.db",
          "examples": ["~/.eavs/keys.db", "/var/lib/eavs/keys.db"]
        },
        "master_key": {
          "type": ["string", "null"],
          "description": "Master key for admin API. Supports 'env:VAR_NAME' syntax.",
          "examples": ["env:EAVS_MASTER_KEY", "sk-admin-secret"]
        },
        "allow_self_provisioning": {
          "type": "boolean",
          "description": "Allow creating keys without master key",
          "default": false
        },
        "default_rpm_limit": {
          "type": ["integer", "null"],
          "description": "Default rate limit for new keys (requests per minute, null = unlimited)",
          "minimum": 0,
          "examples": [60, 100, null]
        },
        "default_budget_usd": {
          "type": ["number", "null"],
          "description": "Default budget for new keys in USD (null = unlimited)",
          "minimum": 0,
          "examples": [10.0, 100.0, null]
        },
        "update_pricing_on_startup": {
          "type": "boolean",
          "description": "Fetch latest model pricing from LiteLLM on startup",
          "default": false
        },
        "word_lists_path": {
          "type": ["string", "null"],
          "description": "Path to word lists TOML file for human-readable key IDs. If not specified, downloads to XDG data directory.",
          "examples": ["~/.config/eavs/word_lists.toml", null]
        }
      },
      "additionalProperties": false
    },
    "capture": {
      "type": "object",
      "description": "Transparent traffic capture via mitmproxy. Requires mitmproxy 10.1.5+ to be installed.",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable automatic mitmproxy capture mode",
          "default": false
        },
        "mitmproxy_path": {
          "type": "string",
          "description": "Path to mitmproxy executable (default uses PATH)",
          "default": "mitmproxy",
          "examples": [
            "mitmproxy",
            "/usr/local/bin/mitmproxy",
            "/opt/homebrew/bin/mitmproxy"
          ]
        },
        "mode": {
          "type": "string",
          "description": "Capture mode: 'local' for all traffic, 'local:AppName' for specific app",
          "default": "local",
          "examples": ["local", "local:ChatGPT", "local:Claude", "local:curl"]
        },
        "verbose": {
          "type": "boolean",
          "description": "Enable verbose logging from mitmproxy addon",
          "default": false
        },
        "api_only": {
          "type": "boolean",
          "description": "Only capture API traffic (skip desktop app domains like chat.openai.com)",
          "default": false
        },
        "addon_path": {
          "type": ["string", "null"],
          "description": "Custom path to eavs_capture.py addon script. Auto-detected if not specified.",
          "examples": ["/path/to/eavs_capture.py", null]
        },
        "extra_args": {
          "type": "array",
          "description": "Additional mitmproxy command-line arguments",
          "default": [],
          "items": {
            "type": "string"
          },
          "examples": [["--quiet"], ["--listen-port", "8080"]]
        }
      },
      "additionalProperties": false
    }
  },
  "$defs": {
    "policyRule": {
      "description": "Single policy rule (deny/rewrite_model/filter_tools)",
      "oneOf": [
        {
          "type": "object",
          "properties": {
            "action": { "const": "deny" },
            "provider": {
              "type": ["string", "null"],
              "description": "Glob match against provider name"
            },
            "model": {
              "type": ["string", "null"],
              "description": "Glob match against requested model"
            },
            "path": {
              "type": ["string", "null"],
              "description": "Glob match against request path (e.g. /v1/chat/completions)"
            },
            "reason": {
              "type": ["string", "null"],
              "description": "User-facing denial reason"
            }
          },
          "required": ["action"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "properties": {
            "action": { "const": "rewrite_model" },
            "provider": {
              "type": ["string", "null"],
              "description": "Glob match against provider name"
            },
            "model": {
              "type": ["string", "null"],
              "description": "Glob match against requested model"
            },
            "to": { "type": "string", "description": "Replacement model name" }
          },
          "required": ["action", "to"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "properties": {
            "action": { "const": "filter_tools" },
            "provider": {
              "type": ["string", "null"],
              "description": "Glob match against provider name"
            },
            "model": {
              "type": ["string", "null"],
              "description": "Glob match against requested model"
            },
            "allow": {
              "type": ["array", "null"],
              "description": "Allow-list tool name globs",
              "items": { "type": "string" }
            },
            "deny": {
              "type": ["array", "null"],
              "description": "Deny-list tool name globs",
              "items": { "type": "string" }
            }
          },
          "required": ["action"],
          "additionalProperties": false
        }
      ]
    },
    "analysisPlugin": {
      "type": "object",
      "description": "Analysis plugin process configuration",
      "properties": {
        "name": {
          "type": "string",
          "description": "Plugin name (for logs/observability)",
          "default": ""
        },
        "command": {
          "type": "string",
          "description": "Executable to run (resolved via PATH unless absolute)",
          "default": ""
        },
        "args": {
          "type": "array",
          "description": "Arguments to pass to the plugin",
          "default": [],
          "items": {
            "type": "string"
          }
        },
        "env": {
          "type": "object",
          "description": "Environment variables for the plugin (supports env:VAR values)",
          "default": {},
          "additionalProperties": {
            "type": "string"
          }
        }
      },
      "required": ["name", "command"],
      "additionalProperties": false
    },
    "provider": {
      "type": "object",
      "description": "LLM provider configuration",
      "properties": {
        "type": {
          "type": "string",
          "description": "Provider type",
          "enum": [
            "openai",
            "anthropic",
            "google",
            "azure",
            "mistral",
            "groq",
            "cerebras",
            "xai",
            "openrouter",
            "bedrock",
            "aws-bedrock",
            "ollama",
            "vllm",
            "openai-compatible"
          ],
          "default": "openai"
        },
        "api_key": {
          "type": "string",
          "description": "API key. Supports 'env:VAR_NAME' syntax to read from environment.",
          "examples": ["env:OPENAI_API_KEY", "sk-..."]
        },
        "base_url": {
          "type": "string",
          "description": "Base URL for the API. Defaults based on provider type if not specified. Supports 'env:VAR_NAME' syntax to read from environment.",
          "format": "uri",
          "examples": [
            "https://api.openai.com/v1",
            "https://api.anthropic.com/v1",
            "http://localhost:11434/v1"
          ]
        },
        "api_version": {
          "type": ["string", "null"],
          "description": "API version (primarily for Azure OpenAI). Supports 'env:VAR_NAME' syntax.",
          "examples": ["2024-02-15-preview", "env:AZURE_OPENAI_API_VERSION"]
        },
        "deployment": {
          "type": "string",
          "description": "Azure deployment name (Azure only). If not set, uses model name as deployment. Supports 'env:VAR_NAME' syntax.",
          "examples": ["my-gpt4-deployment", "env:AZURE_DEPLOYMENT"]
        },
        "compat": {
          "$ref": "#/$defs/compatSettings"
        },
        "headers": {
          "type": "object",
          "description": "Custom headers to add to requests. Values support 'env:VAR_NAME' syntax.",
          "additionalProperties": {
            "type": "string"
          }
        },
        "aws_region": {
          "type": "string",
          "description": "AWS region (Bedrock only). Supports 'env:VAR_NAME' syntax.",
          "examples": ["us-east-1", "env:AWS_REGION"]
        },
        "aws_access_key_id": {
          "type": "string",
          "description": "AWS access key id (Bedrock only). Supports 'env:VAR_NAME' syntax.",
          "examples": ["env:AWS_ACCESS_KEY_ID"]
        },
        "aws_secret_access_key": {
          "type": "string",
          "description": "AWS secret access key (Bedrock only). Supports 'env:VAR_NAME' syntax.",
          "examples": ["env:AWS_SECRET_ACCESS_KEY"]
        },
        "aws_session_token": {
          "type": "string",
          "description": "AWS session token (Bedrock only, optional). Supports 'env:VAR_NAME' syntax.",
          "examples": ["env:AWS_SESSION_TOKEN"]
        },
        "aws_service": {
          "type": "string",
          "description": "AWS service name for SigV4 (Bedrock only).",
          "default": "bedrock",
          "examples": ["bedrock"]
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "type": { "enum": ["bedrock", "aws-bedrock"] }
            }
          },
          "then": {
            "required": [
              "aws_region",
              "aws_access_key_id",
              "aws_secret_access_key"
            ]
          }
        }
      ],
      "additionalProperties": false
    },
    "compatSettings": {
      "type": "object",
      "description": "Compatibility settings for OpenAI-compatible APIs",
      "properties": {
        "supports_developer_role": {
          "type": ["boolean", "null"],
          "description": "Whether the provider supports the 'developer' role (vs 'system')"
        },
        "supports_store": {
          "type": ["boolean", "null"],
          "description": "Whether the provider supports the 'store' field"
        },
        "max_tokens_field": {
          "type": ["string", "null"],
          "description": "Field name for max tokens ('max_tokens' or 'max_completion_tokens')",
          "enum": ["max_tokens", "max_completion_tokens", null]
        }
      },
      "additionalProperties": false
    },
    "logBackend": {
      "oneOf": [
        {
          "type": "object",
          "description": "Standard output logging",
          "properties": {
            "type": {
              "const": "stdout"
            },
            "format": {
              "type": "string",
              "description": "Log format",
              "enum": ["json", "pretty"],
              "default": "json"
            }
          },
          "required": ["type"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "description": "File-based logging",
          "properties": {
            "type": {
              "const": "file"
            },
            "path": {
              "type": "string",
              "description": "Path to log file"
            },
            "rotate": {
              "type": "string",
              "description": "Rotation strategy",
              "enum": ["daily", "size", "none"],
              "default": "none"
            },
            "max_size": {
              "type": ["integer", "null"],
              "description": "Max file size in bytes (for size-based rotation)",
              "minimum": 1
            }
          },
          "required": ["type", "path"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "description": "Webhook/HTTP endpoint logging",
          "properties": {
            "type": {
              "const": "webhook"
            },
            "url": {
              "type": "string",
              "description": "URL to POST logs to",
              "format": "uri"
            },
            "headers": {
              "type": "object",
              "description": "Custom headers. Values support 'env:VAR_NAME' syntax.",
              "additionalProperties": {
                "type": "string"
              }
            },
            "batch_size": {
              "type": "integer",
              "description": "Batch size before sending",
              "default": 100,
              "minimum": 1
            },
            "flush_interval_secs": {
              "type": "integer",
              "description": "Flush interval in seconds",
              "default": 5,
              "minimum": 1
            }
          },
          "required": ["type", "url"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "description": "OpenTelemetry export",
          "properties": {
            "type": {
              "enum": ["otel", "opentelemetry"]
            },
            "endpoint": {
              "type": "string",
              "description": "OTLP endpoint",
              "format": "uri"
            },
            "protocol": {
              "type": "string",
              "description": "Protocol to use",
              "enum": ["grpc", "http"],
              "default": "grpc"
            },
            "service_name": {
              "type": "string",
              "description": "Service name for traces",
              "default": "eavs"
            }
          },
          "required": ["type", "endpoint"],
          "additionalProperties": false
        }
      ]
    }
  },
  "additionalProperties": false
}
